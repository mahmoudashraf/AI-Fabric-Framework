[[1;34mINFO[m] Scanning for projects...
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m-----< [0;36mcom.ai.infrastructure:relationship-query-integration-tests[0;1m >-----[m
[[1;34mINFO[m] [1mBuilding Relationship Query Real API Integration Tests 1.0.0[m
[[1;34mINFO[m] [1m--------------------------------[ jar ]---------------------------------[m
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m--- [0;32mmaven-resources-plugin:2.6:resources[m [1m(default-resources)[m @ [36mrelationship-query-integration-tests[0;1m ---[m
[[1;34mINFO[m] Using 'UTF-8' encoding to copy filtered resources.
[[1;34mINFO[m] skip non existing resourceDirectory /workspace/ai-infrastructure-module/relationship-query-integration-tests/src/main/resources
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m--- [0;32mmaven-compiler-plugin:3.13.0:compile[m [1m(default-compile)[m @ [36mrelationship-query-integration-tests[0;1m ---[m
[[1;34mINFO[m] Nothing to compile - all classes are up to date.
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m--- [0;32mmaven-resources-plugin:2.6:testResources[m [1m(default-testResources)[m @ [36mrelationship-query-integration-tests[0;1m ---[m
[[1;34mINFO[m] Using 'UTF-8' encoding to copy filtered resources.
[[1;34mINFO[m] Copying 2 resources
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m--- [0;32mmaven-compiler-plugin:3.13.0:testCompile[m [1m(default-testCompile)[m @ [36mrelationship-query-integration-tests[0;1m ---[m
[[1;34mINFO[m] Nothing to compile - all classes are up to date.
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m--- [0;32mmaven-surefire-plugin:3.0.0:test[m [1m(default-test)[m @ [36mrelationship-query-integration-tests[0;1m ---[m
[[1;34mINFO[m] Using auto detected provider org.apache.maven.surefire.junitplatform.JUnitPlatformProvider
[[1;34mINFO[m] 
[[1;34mINFO[m] -------------------------------------------------------
[[1;34mINFO[m]  T E S T S
[[1;34mINFO[m] -------------------------------------------------------
[[1;34mINFO[m] Running com.ai.infrastructure.relationship.it.realapi.[1mFinancialFraudRealApiIntegrationTest[m

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.2.0)

2025-11-24T20:36:13.832Z  INFO 81531 --- [           main] i.r.FinancialFraudRealApiIntegrationTest : Starting FinancialFraudRealApiIntegrationTest using Java 21.0.8 with PID 81531 (started by ubuntu in /workspace/ai-infrastructure-module/relationship-query-integration-tests)
2025-11-24T20:36:13.834Z  INFO 81531 --- [           main] i.r.FinancialFraudRealApiIntegrationTest : The following 1 profile is active: "realapi"
2025-11-24T20:36:14.441Z  INFO 81531 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2025-11-24T20:36:14.477Z  INFO 81531 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 32 ms. Found 10 JPA repository interfaces.
2025-11-24T20:36:14.784Z  INFO 81531 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=c8f8f7af-0bee-363f-bc14-0a0b8346c1b9
2025-11-24T20:36:15.257Z  INFO 81531 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 0 (http)
2025-11-24T20:36:15.262Z  INFO 81531 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2025-11-24T20:36:15.263Z  INFO 81531 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.16]
2025-11-24T20:36:15.290Z  INFO 81531 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2025-11-24T20:36:15.290Z  INFO 81531 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1447 ms
2025-11-24T20:36:15.497Z  INFO 81531 --- [           main] o.hibernate.jpa.internal.util.LogHelper  : HHH000204: Processing PersistenceUnitInfo [name: default]
2025-11-24T20:36:15.522Z  INFO 81531 --- [           main] org.hibernate.Version                    : HHH000412: Hibernate ORM core version 6.3.1.Final
2025-11-24T20:36:15.539Z  INFO 81531 --- [           main] o.h.c.internal.RegionFactoryInitiator    : HHH000026: Second-level cache disabled
2025-11-24T20:36:15.645Z  INFO 81531 --- [           main] o.s.o.j.p.SpringPersistenceUnitInfo      : No LoadTimeWeaver setup: ignoring JPA class transformer
2025-11-24T20:36:15.664Z  INFO 81531 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2025-11-24T20:36:15.760Z  INFO 81531 --- [           main] com.zaxxer.hikari.pool.HikariPool        : HikariPool-1 - Added connection conn0: url=jdbc:h2:mem:relationship_query_realapi user=SA
2025-11-24T20:36:15.761Z  INFO 81531 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2025-11-24T20:36:16.383Z  INFO 81531 --- [           main] o.h.e.t.j.p.i.JtaPlatformInitiator       : HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
2025-11-24T20:36:16.424Z  INFO 81531 --- [           main] j.LocalContainerEntityManagerFactoryBean : Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-11-24T20:36:16.467Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXAutoConfiguration       : Creating ONNX Embedding Provider (primary/default)
2025-11-24T20:36:16.468Z  WARN 81531 --- [           main] c.a.i.p.onnx.ONNXAutoConfiguration       : WARNING: ONNX Embedding Provider is not available. Model file may be missing.
2025-11-24T20:36:16.468Z  WARN 81531 --- [           main] c.a.i.p.onnx.ONNXAutoConfiguration       : Please ensure the ONNX model file exists at: classpath:/models/embeddings/all-MiniLM-L6-v2.onnx
2025-11-24T20:36:16.471Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : ========================================
2025-11-24T20:36:16.471Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Initializing ONNX Embedding Provider
2025-11-24T20:36:16.471Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Model path: classpath:/models/embeddings/all-MiniLM-L6-v2.onnx
2025-11-24T20:36:16.471Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Tokenizer path: classpath:/models/embeddings/tokenizer.json
2025-11-24T20:36:16.471Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Current working directory: /workspace/ai-infrastructure-module/relationship-query-integration-tests
2025-11-24T20:36:16.471Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : ========================================
2025-11-24T20:36:17.068Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Model file resolved to: /tmp/onnx-model-5465404722564732059.onnx
2025-11-24T20:36:17.190Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Using CPU for ONNX inference
2025-11-24T20:36:17.473Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Model input names: [input_ids, attention_mask, token_type_ids]
2025-11-24T20:36:17.473Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       :   Input: input_ids - TensorInfo(javaType=INT64,onnxType=ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64,shape=[-1, -1])
2025-11-24T20:36:17.473Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       :   Input: attention_mask - TensorInfo(javaType=INT64,onnxType=ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64,shape=[-1, -1])
2025-11-24T20:36:17.473Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       :   Input: token_type_ids - TensorInfo(javaType=INT64,onnxType=ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64,shape=[-1, -1])
2025-11-24T20:36:17.473Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Detected embedding dimension: 384
2025-11-24T20:36:17.476Z  WARN 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : Hugging Face tokenizers library not found on classpath. Falling back to legacy tokenization.
2025-11-24T20:36:17.476Z  INFO 81531 --- [           main] c.a.i.p.onnx.ONNXEmbeddingProvider       : ONNX Embedding Provider initialized successfully with model: /tmp/onnx-model-5465404722564732059.onnx
2025-11-24T20:36:17.481Z  INFO 81531 --- [           main] .a.i.c.AIInfrastructureAutoConfiguration : Creating AIEmbeddingService with embedding provider 'onnx' (requested 'onnx')
2025-11-24T20:36:17.502Z  INFO 81531 --- [           main] c.ai.infrastructure.cache.AICacheConfig  : AI Cache Manager configured with max size 100 and TTL PT1H
2025-11-24T20:36:17.520Z  INFO 81531 --- [           main] c.a.i.v.l.LuceneVectorDatabaseService    : Initializing Lucene Vector Database at: /tmp/relationship-query-realapi-lucene
2025-11-24T20:36:17.529Z  INFO 81531 --- [           main] o.a.l.s.MemorySegmentIndexInputProvider  : Using MemorySegmentIndexInput with Java 21 or later; to disable start with -Dorg.apache.lucene.store.MMapDirectory.enableMemorySegments=false
2025-11-24T20:36:17.599Z  INFO 81531 --- [           main] c.a.i.v.l.LuceneVectorDatabaseService    : Lucene Vector Database initialized successfully
2025-11-24T20:36:17.638Z  INFO 81531 --- [           main] c.a.i.provider.AIProviderManager         : Initializing AI Provider Manager with 1 providers
2025-11-24T20:36:17.639Z  INFO 81531 --- [           main] c.a.i.provider.AIProviderManager         : AI Provider Manager initialized successfully
2025-11-24T20:36:17.647Z  INFO 81531 --- [           main] c.RelationshipEntityMappingConfiguration : Registered relationship-test entity schema: 8 entities, 4 relationships
2025-11-24T20:36:17.657Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : Loading AI entity configuration from: ai-entity-config.yml
2025-11-24T20:36:17.661Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : Found 3 entities in configuration
2025-11-24T20:36:17.661Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : Processing entity type: document with config keys: [features, searchable-fields]
2025-11-24T20:36:17.661Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : No metadata-fields found for entity document
2025-11-24T20:36:17.661Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : Processing entity type: product with config keys: [features, searchable-fields]
2025-11-24T20:36:17.662Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : No metadata-fields found for entity product
2025-11-24T20:36:17.662Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : Processing entity type: transaction with config keys: [features, searchable-fields]
2025-11-24T20:36:17.662Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : No metadata-fields found for entity transaction
2025-11-24T20:36:17.662Z  INFO 81531 --- [           main] c.a.i.c.AIEntityConfigurationLoader      : Successfully loaded configuration for 3 entities
2025-11-24T20:36:17.974Z  INFO 81531 --- [           main] o.s.d.j.r.query.QueryEnhancerFactory     : Hibernate is in classpath; If applicable, HQL parser will be used.
2025-11-24T20:36:18.290Z  INFO 81531 --- [           main] c.a.i.config.AIConfigurationService      : Initializing AI Configuration Service
2025-11-24T20:36:18.291Z  INFO 81531 --- [           main] c.a.i.config.AIConfigurationService      : Hot-reload enabled with 300 second interval
2025-11-24T20:36:18.291Z  INFO 81531 --- [           main] c.a.i.config.AIConfigurationService      : AI Configuration Service initialized successfully
2025-11-24T20:36:18.308Z  INFO 81531 --- [           main] c.a.i.service.AICapabilityService        : AICapabilityService initialized with configurationLoader: present
2025-11-24T20:36:18.308Z  INFO 81531 --- [           main] c.a.i.service.AICapabilityService        : Configuration loader supports entity types: [product, document, transaction]
2025-11-24T20:36:18.428Z  INFO 81531 --- [           main] c.a.i.privacy.pii.PIIDetectionService    : PII detection initialized: enabled=false, mode=PASS_THROUGH, patterns=4
2025-11-24T20:36:18.566Z  INFO 81531 --- [           main] c.a.i.i.action.ActionHandlerRegistry     : ActionHandlerRegistry initialized with 2 action handler(s)
2025-11-24T20:36:18.673Z  INFO 81531 --- [           main] i.r.c.RelationshipQueryAutoConfiguration : Relationship query module enabled (maxTraversalDepth=3, defaultReturnMode=IDS, vectorSearchEnabled=true)
2025-11-24T20:36:18.772Z  WARN 81531 --- [           main] JpaBaseConfiguration$JpaWebConfiguration : spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-11-24T20:36:19.206Z  INFO 81531 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 1 endpoint(s) beneath base path '/actuator'
2025-11-24T20:36:19.387Z  INFO 81531 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 43261 (http) with context path ''
2025-11-24T20:36:19.401Z  INFO 81531 --- [           main] i.r.FinancialFraudRealApiIntegrationTest : Started FinancialFraudRealApiIntegrationTest in 5.802 seconds (process running for 6.417)
2025-11-24T20:36:20.128Z  INFO 81531 --- [o-auto-1-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2025-11-24T20:36:20.128Z  INFO 81531 --- [o-auto-1-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2025-11-24T20:36:20.129Z  INFO 81531 --- [o-auto-1-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms
2025-11-24T20:36:20.169Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Executing query='List suspicious transactions over $25k from high-risk regions routed through the same counterparty' entityTypes=[transaction]

=== OPENAI API REQUEST ===
URL: https://api.openai.com/v1/chat/completions
Model: gpt-4o-mini
Temperature: 0.1
Top-P: 0.1
Max Tokens: 1200
Messages count: 2

Message 0: role=system
  content: You are an expert database planner. Return ONLY a JSON object.

Message 1: role=user
  content (first 1000 chars): Analyze the user's request using the provided entity schema. Produce a JSON payload with:
- primaryEntityType (snake-case)
- candidateEntityTypes (array)
- relationshipPaths (array of {fromEntityType, relationshipType, toEntityType, direction, optional, conditions})
- directFilters (map of entity -> array of filters)
- relationshipFilters (map)
- needsSemanticSearch (boolean)
- queryStrategy ("RELATIONSHIP", "SEMANTIC", or "HYBRID")
- confidence (0.0 - 1.0 decimal)
- semanticQuery (string)

Guidelines:
- candidateEntityTypes MUST always include the primaryEntityType.
- Each element inside directFilters/relationshipFilters MUST be an array of objects shaped like {"field":"entity.field","operator":"GREATER_THAN","value":123}. Valid operators: EQUALS, NOT_EQUALS, GREATER_THAN, GREATER_THAN_OR_EQUAL, LESS_THAN, LESS_THAN_OR_EQUAL, BETWEEN, IN, LIKE.
- relationshipPaths[].conditions follows the exact same object structure (arrays of filter objects).
- Use fully-qualified field names such as
  content (total length): 1513 chars
=== END REQUEST ===

=== OPENAI API RESPONSE ===
Response Time: 6425ms
Model: gpt-4o-mini-2024-07-18
Finish Reason: stop
Response Content Length: 1211 chars
Content (first 500 chars):
```json
{
  "primaryEntityType": "transaction",
  "candidateEntityTypes": [
    "transaction"
  ],
  "relationshipPaths": [
    {
      "fromEntityType": "transaction",
      "relationshipType": "destinationAccount",
      "toEntityType": "destination-account",
      "direction": "FORWARD",
      "optional": false,
      "conditions": []
    },
    {
      "fromEntityType": "transaction",
      "relationshipType": "sourceAccount",
      "toEntityType": "origin-account",
      "direction": "FORWA
=== END RESPONSE ===

2025-11-24T20:36:26.623Z  WARN 81531 --- [o-auto-1-exec-1] c.a.i.relationship.metrics.QueryMetrics  : Plan latency 6453ms exceeded alert threshold 1500
2025-11-24T20:36:26.628Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Planner output:
{
  "originalQuery" : "List suspicious transactions over $25k from high-risk regions routed through the same counterparty",
  "semanticQuery" : "List suspicious transactions over $25k from high-risk regions routed through the same counterparty",
  "primaryEntityType" : "transaction",
  "candidateEntityTypes" : [ "transaction" ],
  "relationshipPaths" : [ {
    "fromEntityType" : "transaction",
    "relationshipType" : "destinationAccount",
    "toEntityType" : "destination-account",
    "direction" : "FORWARD",
    "optional" : false,
    "conditions" : [ {
      "rangeComparison" : false,
      "field" : "region",
      "operator" : "ILIKE",
      "value" : "%high-risk%",
      "entityType" : "destination-account",
      "caseSensitive" : true
    } ]
  }, {
    "fromEntityType" : "transaction",
    "relationshipType" : "sourceAccount",
    "toEntityType" : "origin-account",
    "direction" : "FORWARD",
    "optional" : false,
    "conditions" : [ ]
  } ],
  "directFilters" : {
    "transaction" : [ {
      "rangeComparison" : false,
      "field" : "amount",
      "operator" : "GREATER_THAN",
      "value" : 25000,
      "entityType" : "transaction",
      "caseSensitive" : true
    } ]
  },
  "relationshipFilters" : { },
  "metadataFilters" : { },
  "queryStrategy" : "RELATIONSHIP",
  "needsSemanticSearch" : false,
  "confidence" : 0.85,
  "context" : { }
}
2025-11-24T20:36:26.631Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] JPQL statement: SELECT DISTINCT root FROM TransactionEntity root JOIN root.destinationAccount de1 JOIN root.sourceAccount or1 WHERE LOWER(de1.region) LIKE :p1 AND root.amount > :p2
Parameters: {p1=%high-risk%, p2=25000}
2025-11-24T20:36:26.701Z  WARN 81531 --- [o-auto-1-exec-1] c.a.i.relationship.metrics.QueryMetrics  : Execution latency 6531ms exceeded alert threshold 1500
2025-11-24T20:36:26.701Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Result summary -> query='List suspicious transactions over $25k from high-risk regions routed through the same counterparty', entityTypes=[transaction], totalCandidates=3, returned=3, hybridMode=false
2025-11-24T20:36:26.701Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Document IDs: [02b23d4d-e890-4104-b2a0-7ae162614ac6, 99dc49a4-1ed8-4105-aba0-21eb2fb32c75, d52e1d0e-eb0c-42ac-9624-2cd606ce73e4]
2025-11-24T20:36:26.701Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] JPQL (repeated for reference): SELECT DISTINCT root FROM TransactionEntity root JOIN root.destinationAccount de1 JOIN root.sourceAccount or1 WHERE LOWER(de1.region) LIKE :p1 AND root.amount > :p2
Parameters: {p1=%high-risk%, p2=25000}
2025-11-24T20:36:26.706Z  INFO 81531 --- [o-auto-1-exec-1] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Serialized response:
{
  "documents" : [ {
    "id" : "02b23d4d-e890-4104-b2a0-7ae162614ac6",
    "content" : "Cleared Wire 32k - Wire 32000",
    "title" : null,
    "type" : null,
    "score" : null,
    "similarity" : null,
    "metadata" : {
      "status" : "CLEARED",
      "destinationRegion" : "high-risk corridor",
      "sourceRegion" : "high-risk region"
    },
    "embeddings" : null,
    "highlightedContent" : null,
    "source" : null,
    "url" : null,
    "createdAt" : null,
    "modifiedAt" : null,
    "author" : null,
    "tags" : null,
    "language" : null,
    "size" : null,
    "wordCount" : null,
    "readingTimeMinutes" : null,
    "qualityScore" : null,
    "freshnessScore" : null,
    "authorityScore" : null
  }, {
    "id" : "99dc49a4-1ed8-4105-aba0-21eb2fb32c75",
    "content" : "Pending Wire 40k - Wire 40000",
    "title" : null,
    "type" : null,
    "score" : null,
    "similarity" : null,
    "metadata" : {
      "status" : "PENDING_REVIEW",
      "destinationRegion" : "high-risk corridor",
      "sourceRegion" : "high-risk region"
    },
    "embeddings" : null,
    "highlightedContent" : null,
    "source" : null,
    "url" : null,
    "createdAt" : null,
    "modifiedAt" : null,
    "author" : null,
    "tags" : null,
    "language" : null,
    "size" : null,
    "wordCount" : null,
    "readingTimeMinutes" : null,
    "qualityScore" : null,
    "freshnessScore" : null,
    "authorityScore" : null
  }, {
    "id" : "d52e1d0e-eb0c-42ac-9624-2cd606ce73e4",
    "content" : "ACH 50k Stable - ACH 50000",
    "title" : null,
    "type" : null,
    "score" : null,
    "similarity" : null,
    "metadata" : {
      "status" : "PENDING_REVIEW",
      "destinationRegion" : "high-risk corridor",
      "sourceRegion" : "stable region"
    },
    "embeddings" : null,
    "highlightedContent" : null,
    "source" : null,
    "url" : null,
    "createdAt" : null,
    "modifiedAt" : null,
    "author" : null,
    "tags" : null,
    "language" : null,
    "size" : null,
    "wordCount" : null,
    "readingTimeMinutes" : null,
    "qualityScore" : null,
    "freshnessScore" : null,
    "authorityScore" : null
  } ],
  "response" : null,
  "context" : null,
  "totalDocuments" : null,
  "usedDocuments" : null,
  "relevanceScores" : null,
  "success" : true,
  "hybridSearchUsed" : false,
  "contextualSearchUsed" : null,
  "searchedCategories" : null,
  "totalResults" : 3,
  "returnedResults" : 3,
  "maxScore" : null,
  "averageScore" : null,
  "processingTimeMs" : 6531,
  "requestId" : null,
  "originalQuery" : "List suspicious transactions over $25k from high-risk regions routed through the same counterparty",
  "entityType" : "transaction",
  "model" : null,
  "timestamp" : null,
  "metadata" : {
    "plan" : {
      "originalQuery" : "List suspicious transactions over $25k from high-risk regions routed through the same counterparty",
      "semanticQuery" : "List suspicious transactions over $25k from high-risk regions routed through the same counterparty",
      "primaryEntityType" : "transaction",
      "candidateEntityTypes" : [ "transaction" ],
      "relationshipPaths" : [ {
        "fromEntityType" : "transaction",
        "relationshipType" : "destinationAccount",
        "toEntityType" : "destination-account",
        "direction" : "FORWARD",
        "optional" : false,
        "conditions" : [ {
          "rangeComparison" : false,
          "field" : "region",
          "operator" : "ILIKE",
          "value" : "%high-risk%",
          "entityType" : "destination-account",
          "caseSensitive" : true
        } ]
      }, {
        "fromEntityType" : "transaction",
        "relationshipType" : "sourceAccount",
        "toEntityType" : "origin-account",
        "direction" : "FORWARD",
        "optional" : false,
        "conditions" : [ ]
      } ],
      "directFilters" : {
        "transaction" : [ {
          "rangeComparison" : false,
          "field" : "amount",
          "operator" : "GREATER_THAN",
          "value" : 25000,
          "entityType" : "transaction",
          "caseSensitive" : true
        } ]
      },
      "relationshipFilters" : { },
      "metadataFilters" : { },
      "queryStrategy" : "RELATIONSHIP",
      "needsSemanticSearch" : false,
      "confidence" : 0.85,
      "context" : { }
    },
    "timestamp" : "2025-11-24T20:36:26.701492722Z",
    "mode" : "STANDALONE"
  },
  "fromCache" : null,
  "piiDetectionResult" : null,
  "cacheHitRate" : null,
  "errorMessage" : null,
  "warnings" : [ ],
  "suggestions" : null,
  "relatedQueries" : null,
  "facets" : null,
  "aggregations" : null,
  "confidenceScore" : 0.85,
  "qualityThresholdMet" : null,
  "query" : "List suspicious transactions over $25k from high-risk regions routed through the same counterparty"
}
[[1;34mINFO[m] [1;32mTests run: [0;1;32m1[m, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 13.403 s - in com.ai.infrastructure.relationship.it.realapi.[1mFinancialFraudRealApiIntegrationTest[m
[[1;34mINFO[m] Running com.ai.infrastructure.relationship.it.realapi.[1mECommerceRealApiIntegrationTest[m
2025-11-24T20:36:26.870Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Executing query='Show me blue shoes under $100 from Nike' entityTypes=[product]

=== OPENAI API REQUEST ===
URL: https://api.openai.com/v1/chat/completions
Model: gpt-4o-mini
Temperature: 0.1
Top-P: 0.1
Max Tokens: 1200
Messages count: 2

Message 0: role=system
  content: You are an expert database planner. Return ONLY a JSON object.

Message 1: role=user
  content (first 1000 chars): Analyze the user's request using the provided entity schema. Produce a JSON payload with:
- primaryEntityType (snake-case)
- candidateEntityTypes (array)
- relationshipPaths (array of {fromEntityType, relationshipType, toEntityType, direction, optional, conditions})
- directFilters (map of entity -> array of filters)
- relationshipFilters (map)
- needsSemanticSearch (boolean)
- queryStrategy ("RELATIONSHIP", "SEMANTIC", or "HYBRID")
- confidence (0.0 - 1.0 decimal)
- semanticQuery (string)

Guidelines:
- candidateEntityTypes MUST always include the primaryEntityType.
- Each element inside directFilters/relationshipFilters MUST be an array of objects shaped like {"field":"entity.field","operator":"GREATER_THAN","value":123}. Valid operators: EQUALS, NOT_EQUALS, GREATER_THAN, GREATER_THAN_OR_EQUAL, LESS_THAN, LESS_THAN_OR_EQUAL, BETWEEN, IN, LIKE.
- relationshipPaths[].conditions follows the exact same object structure (arrays of filter objects).
- Use fully-qualified field names such as
  content (total length): 1371 chars
=== END REQUEST ===

=== OPENAI API RESPONSE ===
Response Time: 10113ms
Model: gpt-4o-mini-2024-07-18
Finish Reason: stop
Response Content Length: 820 chars
Content (first 500 chars):
{
  "primaryEntityType": "product",
  "candidateEntityTypes": [
    "product"
  ],
  "relationshipPaths": [
    {
      "fromEntityType": "product",
      "relationshipType": "brand",
      "toEntityType": "brand",
      "direction": "FORWARD",
      "optional": false,
      "conditions": [
        {
          "field": "brand.name",
          "operator": "EQUALS",
          "value": "Nike"
        }
      ]
    }
  ],
  "directFilters": {
    "product": [
      {
        "field": "product.color"
=== END RESPONSE ===

2025-11-24T20:36:36.987Z  WARN 81531 --- [o-auto-1-exec-2] c.a.i.relationship.metrics.QueryMetrics  : Plan latency 10116ms exceeded alert threshold 1500
2025-11-24T20:36:36.987Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Planner output:
{
  "originalQuery" : "Show me blue shoes under $100 from Nike",
  "semanticQuery" : "Show me blue shoes under $100 from Nike",
  "primaryEntityType" : "product",
  "candidateEntityTypes" : [ "product" ],
  "relationshipPaths" : [ {
    "fromEntityType" : "product",
    "relationshipType" : "brand",
    "toEntityType" : "brand",
    "direction" : "FORWARD",
    "optional" : false,
    "conditions" : [ {
      "rangeComparison" : false,
      "field" : "name",
      "operator" : "EQUALS",
      "value" : "Nike",
      "entityType" : "brand",
      "caseSensitive" : true
    } ]
  } ],
  "directFilters" : {
    "product" : [ {
      "rangeComparison" : false,
      "field" : "color",
      "operator" : "EQUALS",
      "value" : "blue",
      "entityType" : "product",
      "caseSensitive" : true
    }, {
      "rangeComparison" : false,
      "field" : "price",
      "operator" : "LESS_THAN",
      "value" : 100,
      "entityType" : "product",
      "caseSensitive" : true
    } ]
  },
  "relationshipFilters" : { },
  "metadataFilters" : { },
  "queryStrategy" : "RELATIONSHIP",
  "needsSemanticSearch" : false,
  "confidence" : 0.9,
  "context" : { }
}
2025-11-24T20:36:36.987Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] JPQL statement: SELECT DISTINCT root FROM ProductEntity root JOIN root.brand br1 WHERE br1.name = :p1 AND root.color = :p2 AND root.price < :p3
Parameters: {p1=Nike, p2=blue, p3=100}
2025-11-24T20:36:36.999Z  WARN 81531 --- [o-auto-1-exec-2] c.a.i.relationship.metrics.QueryMetrics  : Execution latency 10128ms exceeded alert threshold 1500
2025-11-24T20:36:36.999Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Result summary -> query='Show me blue shoes under $100 from Nike', entityTypes=[product], totalCandidates=1, returned=1, hybridMode=false
2025-11-24T20:36:36.999Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Document IDs: [7ff2de2c-4f0a-4d3d-bf8d-281c93f54e54]
2025-11-24T20:36:36.999Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] JPQL (repeated for reference): SELECT DISTINCT root FROM ProductEntity root JOIN root.brand br1 WHERE br1.name = :p1 AND root.color = :p2 AND root.price < :p3
Parameters: {p1=Nike, p2=blue, p3=100}
2025-11-24T20:36:37.000Z  INFO 81531 --- [o-auto-1-exec-2] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Serialized response:
{
  "documents" : [ {
    "id" : "7ff2de2c-4f0a-4d3d-bf8d-281c93f54e54",
    "content" : "Blue Runner (blue) - $85",
    "title" : null,
    "type" : null,
    "score" : null,
    "similarity" : null,
    "metadata" : {
      "brand" : "Nike",
      "status" : "ACTIVE"
    },
    "embeddings" : null,
    "highlightedContent" : null,
    "source" : null,
    "url" : null,
    "createdAt" : null,
    "modifiedAt" : null,
    "author" : null,
    "tags" : null,
    "language" : null,
    "size" : null,
    "wordCount" : null,
    "readingTimeMinutes" : null,
    "qualityScore" : null,
    "freshnessScore" : null,
    "authorityScore" : null
  } ],
  "response" : null,
  "context" : null,
  "totalDocuments" : null,
  "usedDocuments" : null,
  "relevanceScores" : null,
  "success" : true,
  "hybridSearchUsed" : false,
  "contextualSearchUsed" : null,
  "searchedCategories" : null,
  "totalResults" : 1,
  "returnedResults" : 1,
  "maxScore" : null,
  "averageScore" : null,
  "processingTimeMs" : 10128,
  "requestId" : null,
  "originalQuery" : "Show me blue shoes under $100 from Nike",
  "entityType" : "product",
  "model" : null,
  "timestamp" : null,
  "metadata" : {
    "plan" : {
      "originalQuery" : "Show me blue shoes under $100 from Nike",
      "semanticQuery" : "Show me blue shoes under $100 from Nike",
      "primaryEntityType" : "product",
      "candidateEntityTypes" : [ "product" ],
      "relationshipPaths" : [ {
        "fromEntityType" : "product",
        "relationshipType" : "brand",
        "toEntityType" : "brand",
        "direction" : "FORWARD",
        "optional" : false,
        "conditions" : [ {
          "rangeComparison" : false,
          "field" : "name",
          "operator" : "EQUALS",
          "value" : "Nike",
          "entityType" : "brand",
          "caseSensitive" : true
        } ]
      } ],
      "directFilters" : {
        "product" : [ {
          "rangeComparison" : false,
          "field" : "color",
          "operator" : "EQUALS",
          "value" : "blue",
          "entityType" : "product",
          "caseSensitive" : true
        }, {
          "rangeComparison" : false,
          "field" : "price",
          "operator" : "LESS_THAN",
          "value" : 100,
          "entityType" : "product",
          "caseSensitive" : true
        } ]
      },
      "relationshipFilters" : { },
      "metadataFilters" : { },
      "queryStrategy" : "RELATIONSHIP",
      "needsSemanticSearch" : false,
      "confidence" : 0.9,
      "context" : { }
    },
    "timestamp" : "2025-11-24T20:36:36.999558084Z",
    "mode" : "STANDALONE"
  },
  "fromCache" : null,
  "piiDetectionResult" : null,
  "cacheHitRate" : null,
  "errorMessage" : null,
  "warnings" : [ ],
  "suggestions" : null,
  "relatedQueries" : null,
  "facets" : null,
  "aggregations" : null,
  "confidenceScore" : 0.9,
  "qualityThresholdMet" : null,
  "query" : "Show me blue shoes under $100 from Nike"
}
[[1;34mINFO[m] [1;32mTests run: [0;1;32m1[m, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 10.223 s - in com.ai.infrastructure.relationship.it.realapi.[1mECommerceRealApiIntegrationTest[m
[[1;34mINFO[m] Running com.ai.infrastructure.relationship.it.realapi.[1mLawFirmRealApiIntegrationTest[m
2025-11-24T20:36:37.054Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Executing query='Find all contracts related to John Smith in Q4 2023' entityTypes=[document]

=== OPENAI API REQUEST ===
URL: https://api.openai.com/v1/chat/completions
Model: gpt-4o-mini
Temperature: 0.1
Top-P: 0.1
Max Tokens: 1200
Messages count: 2

Message 0: role=system
  content: You are an expert database planner. Return ONLY a JSON object.

Message 1: role=user
  content (first 1000 chars): Analyze the user's request using the provided entity schema. Produce a JSON payload with:
- primaryEntityType (snake-case)
- candidateEntityTypes (array)
- relationshipPaths (array of {fromEntityType, relationshipType, toEntityType, direction, optional, conditions})
- directFilters (map of entity -> array of filters)
- relationshipFilters (map)
- needsSemanticSearch (boolean)
- queryStrategy ("RELATIONSHIP", "SEMANTIC", or "HYBRID")
- confidence (0.0 - 1.0 decimal)
- semanticQuery (string)

Guidelines:
- candidateEntityTypes MUST always include the primaryEntityType.
- Each element inside directFilters/relationshipFilters MUST be an array of objects shaped like {"field":"entity.field","operator":"GREATER_THAN","value":123}. Valid operators: EQUALS, NOT_EQUALS, GREATER_THAN, GREATER_THAN_OR_EQUAL, LESS_THAN, LESS_THAN_OR_EQUAL, BETWEEN, IN, LIKE.
- relationshipPaths[].conditions follows the exact same object structure (arrays of filter objects).
- Use fully-qualified field names such as
  content (total length): 1385 chars
=== END REQUEST ===

=== OPENAI API RESPONSE ===
Response Time: 5225ms
Model: gpt-4o-mini-2024-07-18
Finish Reason: stop
Response Content Length: 760 chars
Content (first 500 chars):
```json
{
  "primaryEntityType": "document",
  "candidateEntityTypes": ["document"],
  "relationshipPaths": [
    {
      "fromEntityType": "document",
      "relationshipType": "author",
      "toEntityType": "user",
      "direction": "FORWARD",
      "optional": false,
      "conditions": [
        {
          "field": "user.name",
          "operator": "EQUALS",
          "value": "John Smith"
        }
      ]
    }
  ],
  "directFilters": {
    "document": [
      {
        "field": "docum
=== END RESPONSE ===

2025-11-24T20:36:42.286Z  WARN 81531 --- [o-auto-1-exec-4] c.a.i.relationship.metrics.QueryMetrics  : Plan latency 5231ms exceeded alert threshold 1500
2025-11-24T20:36:42.295Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Planner output:
RelationshipQueryPlan(originalQuery=Find all contracts related to John Smith in Q4 2023, semanticQuery=Find all contracts related to John Smith in Q4 2023, primaryEntityType=document, candidateEntityTypes=[document], relationshipPaths=[RelationshipPath(fromEntityType=document, relationshipType=author, toEntityType=user, direction=FORWARD, alias=null, optional=false, conditions=[FilterCondition(field=fullName, operator=EQUALS, value=John Smith, secondaryValue=null, entityType=user, caseSensitive=true)])], directFilters={document=[FilterCondition(field=creationDate, operator=BETWEEN, value=2023-10-01T00:00, secondaryValue=2023-12-31T00:00, entityType=document, caseSensitive=true)]}, relationshipFilters={}, metadataFilters={}, queryStrategy=RELATIONSHIP, needsSemanticSearch=false, confidenceScore=0.85, maxTraversalDepth=null, limit=null, preferredMode=null, returnMode=null, additionalContext={})
2025-11-24T20:36:42.295Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] JPQL statement: SELECT DISTINCT root FROM DocumentEntity root JOIN root.author us1 WHERE us1.fullName = :p1 AND root.creationDate BETWEEN :p2 AND :p3
Parameters: {p1=John Smith, p2=2023-10-01T00:00, p3=2023-12-31T00:00}
2025-11-24T20:36:42.303Z  WARN 81531 --- [o-auto-1-exec-4] c.a.i.relationship.metrics.QueryMetrics  : Execution latency 5249ms exceeded alert threshold 1500
2025-11-24T20:36:42.304Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Result summary -> query='Find all contracts related to John Smith in Q4 2023', entityTypes=[document], totalCandidates=2, returned=2, hybridMode=false
2025-11-24T20:36:42.304Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Document IDs: [5e17f48a-45f6-494d-a935-0fb824e06407, 6aa54aa2-b5e2-4e46-9f83-e05dd48b6f95]
2025-11-24T20:36:42.304Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] JPQL (repeated for reference): SELECT DISTINCT root FROM DocumentEntity root JOIN root.author us1 WHERE us1.fullName = :p1 AND root.creationDate BETWEEN :p2 AND :p3
Parameters: {p1=John Smith, p2=2023-10-01T00:00, p3=2023-12-31T00:00}
2025-11-24T20:36:42.309Z  INFO 81531 --- [o-auto-1-exec-4] c.a.i.r.s.LLMDrivenJPAQueryService       : [RelationshipQuery] Serialized response:
RAGResponse(documents=[RAGResponse.RAGDocument(id=5e17f48a-45f6-494d-a935-0fb824e06407, content=Contract - John Smith - Q4 2023, title=null, type=null, score=null, similarity=null, metadata={status=ACTIVE, authorId=f724ff6b-e375-45aa-9430-6b196e53e201}, embeddings=null, highlightedContent=null, source=null, url=null, createdAt=null, modifiedAt=null, author=null, tags=null, language=null, size=null, wordCount=null, readingTimeMinutes=null, qualityScore=null, freshnessScore=null, authorityScore=null), RAGResponse.RAGDocument(id=6aa54aa2-b5e2-4e46-9f83-e05dd48b6f95, content=Contract - John Smith - Q4 2023 (Archive), title=null, type=null, score=null, similarity=null, metadata={status=ARCHIVED, authorId=f724ff6b-e375-45aa-9430-6b196e53e201}, embeddings=null, highlightedContent=null, source=null, url=null, createdAt=null, modifiedAt=null, author=null, tags=null, language=null, size=null, wordCount=null, readingTimeMinutes=null, qualityScore=null, freshnessScore=null, authorityScore=null)], response=null, context=null, totalDocuments=null, usedDocuments=null, relevanceScores=null, success=true, hybridSearchUsed=false, contextualSearchUsed=null, searchedCategories=null, totalResults=2, returnedResults=2, maxScore=null, averageScore=null, processingTimeMs=5249, requestId=null, originalQuery=Find all contracts related to John Smith in Q4 2023, entityType=document, model=null, timestamp=null, metadata={plan=RelationshipQueryPlan(originalQuery=Find all contracts related to John Smith in Q4 2023, semanticQuery=Find all contracts related to John Smith in Q4 2023, primaryEntityType=document, candidateEntityTypes=[document], relationshipPaths=[RelationshipPath(fromEntityType=document, relationshipType=author, toEntityType=user, direction=FORWARD, alias=null, optional=false, conditions=[FilterCondition(field=fullName, operator=EQUALS, value=John Smith, secondaryValue=null, entityType=user, caseSensitive=true)])], directFilters={document=[FilterCondition(field=creationDate, operator=BETWEEN, value=2023-10-01T00:00, secondaryValue=2023-12-31T00:00, entityType=document, caseSensitive=true)]}, relationshipFilters={}, metadataFilters={}, queryStrategy=RELATIONSHIP, needsSemanticSearch=false, confidenceScore=0.85, maxTraversalDepth=null, limit=null, preferredMode=null, returnMode=null, additionalContext={}), timestamp=2025-11-24T20:36:42.304001430Z, mode=STANDALONE}, fromCache=null, piiDetectionResult=null, cacheHitRate=null, errorMessage=null, warnings=[], suggestions=null, relatedQueries=null, facets=null, aggregations=null, confidenceScore=0.85, qualityThresholdMet=null)
[[1;34mINFO[m] [1;32mTests run: [0;1;32m1[m, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5.306 s - in com.ai.infrastructure.relationship.it.realapi.[1mLawFirmRealApiIntegrationTest[m
[[1;34mINFO[m] 
[[1;34mINFO[m] Results:
[[1;34mINFO[m] 
[[1;34mINFO[m] [1;32mTests run: 3, Failures: 0, Errors: 0, Skipped: 0[m
[[1;34mINFO[m] 
[[1;34mINFO[m] [1m------------------------------------------------------------------------[m
[[1;34mINFO[m] [1;32mBUILD SUCCESS[m
[[1;34mINFO[m] [1m------------------------------------------------------------------------[m
[[1;34mINFO[m] Total time:  30.304 s
[[1;34mINFO[m] Finished at: 2025-11-24T20:36:42Z
[[1;34mINFO[m] [1m------------------------------------------------------------------------[m
