meta:
  phase: Phase 3 - Payments, iCal, Analytics, Notifications, RBAC Hardening, AI, Realtime
  goals: >
    Stripe checkout & commissions, iCal export/import, analytics, notifications,
    finer RBAC/audits, AI style recommendations, realtime for notes/bids.

tickets:
  - id: P3.1-A
    title: Stripe payments & webhooks
    backend:
      endpoints:
        - POST /api/payments/checkout {bookingId}
        - POST /webhooks/stripe
      entities: [Deal]
      rules:
        - idempotent_webhook: true
        - booking_confirm_on_succeeded: true
    frontend:
      routes: [/checkout/[bookingId]]
    acceptance:
      - Payment success sets Booking=CONFIRMED; commission recorded

  - id: P3.1-B
    title: Calendar sync (iCal export/import)
    backend:
      endpoints:
        - GET  /api/listings/{id}/ical
        - POST /api/listings/{id}/ical-sources
      jobs: scheduled_fetch_block_dates
    acceptance:
      - Valid .ics export; import blocks dates

  - id: P3.2-A
    title: Analytics (owner/agency/admin)
    backend:
      endpoints:
        - GET /api/analytics/owner
        - GET /api/analytics/agency
        - GET /api/analytics/admin
      metrics: [occupancy_pct, nights_booked, lead_time, offers_per_project, completion_rate, revenue_per_property]
    frontend:
      routes: [/owner/analytics, /agency/analytics, /admin/analytics]
    acceptance:
      - Charts with date filters; p95 < 400ms on dev data

  - id: P3.2-B
    title: Notifications (email + in-app)
    backend:
      entities: [Notification, NotificationPreference]
      events: [bid_received, bid_accepted, milestone_due, booking_confirmed, cleaning_scheduled]
      endpoints: [GET /api/notifications, POST /api/notifications/{id}/read, GET/POST /api/notification-preferences]
    frontend:
      routes: [/notifications, /settings/notifications]
    acceptance:
      - Reliable delivery; user category toggles; 90-day retention

  - id: P3.2-C
    title: RBAC hardening & audits
    backend:
      endpoints: [GET /api/admin/audits]
      notes: fine-grained policies; audit admin actions
    acceptance:
      - Sensitive actions recorded; export CSV

  - id: P3.3-A
    title: AI style recommendations (rules-based)
    backend:
      endpoints: [POST /api/styles/recommend {propertyId}]
    frontend:
      routes: [/owner/properties/[id]/style/recommend]
    acceptance:
      - Deterministic test vectors; feature-flagged

  - id: P3.3-B
    title: Realtime upgrades (WS/SSE) for notes/bids
    backend: notes_channel_ws_or_sse: true
    frontend: replace_polling_with_ws: true
    acceptance:
      - Live updates; offline fallback to polling
