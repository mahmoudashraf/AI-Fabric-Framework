# üóÉÔ∏è AISearchableEntity Storage Location - Complete Guide

**Document Purpose:** Detailed explanation of where `AISearchableEntity` is stored in different environments

**Last Updated:** October 2025  
**Status:** ‚úÖ Complete Storage Analysis

---

## üìã Table of Contents

1. [Entity Definition](#entity-definition)
2. [Storage by Environment](#storage-by-environment)
3. [Database Schema](#database-schema)
4. [Hibernate Configuration](#hibernate-configuration)
5. [Real Examples](#real-examples)

---

## üéØ Entity Definition

### **AISearchableEntity JPA Mapping**

```java
// AISearchableEntity.java
@Entity
@Table(name = "ai_searchable_entities")  // ‚Üê Table name in database
public class AISearchableEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;                    // Primary key
    
    @Column(name = "entity_type", nullable = false)
    private String entityType;            // "product", "user", etc.
    
    @Column(name = "entity_id", nullable = false)  
    private String entityId;              // "prod_123", "user_456"
    
    @Column(name = "searchable_content", columnDefinition = "TEXT")
    private String searchableContent;     // Full text content
    
    @ElementCollection
    @CollectionTable(name = "ai_embeddings", joinColumns = @JoinColumn(name = "entity_id"))
    @Column(name = "embedding_value")
    private List<Double> embeddings;      // Vector embeddings (1536 numbers)
    
    @Column(name = "metadata", columnDefinition = "JSON")
    private String metadata;              // JSON metadata
    
    @Column(name = "ai_analysis", columnDefinition = "TEXT")
    private String aiAnalysis;            // AI-generated analysis
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at") 
    private LocalDateTime updatedAt;
}
```

---

## üåç Storage by Environment

### **Development Environment**

#### **Configuration**
```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:h2:mem:devdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    username: sa
    password: 
    driver-class-name: org.h2.Driver
    
  jpa:
    hibernate:
      ddl-auto: create-drop  # Auto-creates tables
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        
  liquibase:
    enabled: false  # Disabled for H2
```

#### **Storage Location**
- **Database**: H2 In-Memory Database
- **Physical Location**: RAM only (no files)
- **Tables Created**: `ai_searchable_entities` + `ai_embeddings`
- **Persistence**: Lost on application restart
- **Access**: H2 Console at `http://localhost:8081/h2-console`

#### **H2 Console Access**
```bash
# Access H2 database console
URL: http://localhost:8081/h2-console
JDBC URL: jdbc:h2:mem:devdb
Username: sa
Password: (empty)

# Query the tables
SELECT * FROM ai_searchable_entities;
SELECT * FROM ai_embeddings;
```

### **Production Environment**

#### **Configuration**
```yaml
# application-prod.yml
spring:
  datasource:
    url: ${DATABASE_URL}  # PostgreSQL connection
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    
  jpa:
    hibernate:
      ddl-auto: validate  # Validates existing schema
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.yaml
    enabled: true  # Manages schema migrations
```

#### **Storage Location**
- **Database**: PostgreSQL (production database)
- **Physical Location**: Database server specified in `DATABASE_URL`
- **Tables**: `ai_searchable_entities` + `ai_embeddings`
- **Persistence**: Permanent storage with backups
- **Schema Management**: Liquibase migrations

---

## üóÑÔ∏è Database Schema

### **Table Structure (Auto-Generated by Hibernate)**

#### **Main Table: `ai_searchable_entities`**
```sql
CREATE TABLE ai_searchable_entities (
    id VARCHAR(36) PRIMARY KEY,              -- UUID primary key
    entity_type VARCHAR(255) NOT NULL,       -- Entity type ("product", "user")
    entity_id VARCHAR(255) NOT NULL,         -- Original entity ID
    searchable_content TEXT,                 -- Full searchable text
    metadata JSON,                           -- JSON metadata
    ai_analysis TEXT,                        -- AI-generated analysis
    created_at TIMESTAMP,                    -- Creation timestamp
    updated_at TIMESTAMP                     -- Update timestamp
);

-- Indexes (auto-generated by Hibernate)
CREATE INDEX idx_ai_searchable_entity_type ON ai_searchable_entities(entity_type);
CREATE INDEX idx_ai_searchable_entity_id ON ai_searchable_entities(entity_id);
```

#### **Embeddings Table: `ai_embeddings`**
```sql
CREATE TABLE ai_embeddings (
    entity_id VARCHAR(36) NOT NULL,          -- Foreign key to ai_searchable_entities.id
    embedding_value DOUBLE PRECISION NOT NULL -- Each vector dimension
);

-- Foreign key constraint
ALTER TABLE ai_embeddings 
ADD CONSTRAINT fk_ai_embeddings_entity 
FOREIGN KEY (entity_id) REFERENCES ai_searchable_entities(id) 
ON DELETE CASCADE;

-- Index for performance
CREATE INDEX idx_ai_embeddings_entity_id ON ai_embeddings(entity_id);
```

---

## ‚öôÔ∏è Hibernate Configuration

### **How Tables Are Created**

#### **Development (H2)**
```yaml
jpa:
  hibernate:
    ddl-auto: create-drop  # Hibernate creates tables automatically
```

**Process:**
1. Application starts
2. Hibernate scans `@Entity` classes
3. Finds `AISearchableEntity` with `@Table(name = "ai_searchable_entities")`
4. Auto-creates tables in H2 memory database
5. Tables are dropped when application stops

#### **Production (PostgreSQL)**
```yaml
jpa:
  hibernate:
    ddl-auto: validate  # Hibernate validates existing schema
liquibase:
  enabled: true  # Liquibase manages migrations
```

**Process:**
1. Application starts
2. Liquibase runs migrations from `db.changelog-master.yaml`
3. **Note**: Currently no AI table migrations exist in Liquibase
4. Hibernate validates that required tables exist
5. **Issue**: Tables must be created manually or via Hibernate first run

### **Current Migration Gap**

The current Liquibase migrations only include:
```yaml
# db.changelog-master.yaml
databaseChangeLog:
  - include:
      file: db/changelog/V001__users.yaml      # Creates 'users' table
  - include:
      file: db/changelog/V002__ai_profiles.yaml # Creates 'ai_profiles' table
  # Missing: AI Infrastructure tables (ai_searchable_entities, ai_embeddings)
```

**Missing Migration:** No Liquibase migration exists for `ai_searchable_entities` and `ai_embeddings` tables.

---

## üìä Real Examples

### **Development Environment**

#### **H2 Database Location**
```bash
# In-memory database
Database: H2 (jdbc:h2:mem:devdb)
Physical Location: RAM only
Tables: ai_searchable_entities, ai_embeddings
Access: http://localhost:8081/h2-console
```

#### **Example Data in H2**
```sql
-- Query in H2 Console
SELECT * FROM ai_searchable_entities;

-- Example result:
-- id: "550e8400-e29b-41d4-a716-446655440000"
-- entity_type: "product"  
-- entity_id: "prod_123"
-- searchable_content: "Herm√®s Birkin 35 Togo Leather Iconic luxury handbag..."
-- metadata: "{\"category\":\"Handbags\",\"brand\":\"Herm√®s\"}"
-- ai_analysis: "This is a luxury handbag with high investment value"
-- created_at: "2025-10-27 10:30:00"
-- updated_at: "2025-10-27 10:30:00"

SELECT COUNT(*) FROM ai_embeddings WHERE entity_id = '550e8400-e29b-41d4-a716-446655440000';
-- Result: 1536 (one row per embedding dimension)
```

### **Production Environment**

#### **PostgreSQL Database Location**
```bash
# Production database connection
Database: PostgreSQL
Host: ${DATABASE_URL} (e.g., prod-db.company.com:5432)
Database Name: easyluxury
Schema: public
Tables: ai_searchable_entities, ai_embeddings
```

#### **Example Production Query**
```sql
-- Connect to production database
psql -h prod-db.company.com -U easyluxury_prod -d easyluxury

-- Query AI entities
SELECT 
    entity_type,
    COUNT(*) as entity_count,
    AVG(LENGTH(searchable_content)) as avg_content_length
FROM ai_searchable_entities 
GROUP BY entity_type;

-- Example result:
-- entity_type | entity_count | avg_content_length
-- product     | 1250         | 156
-- user        | 890          | 89
-- order       | 2340         | 234

-- Check embedding storage
SELECT 
    COUNT(DISTINCT entity_id) as entities_with_embeddings,
    COUNT(*) as total_embedding_values
FROM ai_embeddings;

-- Example result:
-- entities_with_embeddings | total_embedding_values
-- 2480                     | 3,808,480 (2480 √ó 1536 dimensions)
```

---

## üîß Repository Access

### **Spring Data JPA Repository**

```java
// AISearchableEntityRepository.java
@Repository
public interface AISearchableEntityRepository extends JpaRepository<AISearchableEntity, String> {
    
    // Find by entity type and ID
    Optional<AISearchableEntity> findByEntityTypeAndEntityId(String entityType, String entityId);
    
    // Find all by entity type  
    List<AISearchableEntity> findByEntityType(String entityType);
    
    // Delete by entity type and ID
    void deleteByEntityTypeAndEntityId(String entityType, String entityId);
}
```

### **Usage Example**
```java
@Service
public class AICapabilityService {
    
    @Autowired
    private AISearchableEntityRepository searchableEntityRepository;
    
    public void storeEntityForAI(Object entity, String entityType, String entityId) {
        // Create AI searchable entity
        AISearchableEntity aiEntity = AISearchableEntity.builder()
            .entityType(entityType)           // "product"
            .entityId(entityId)               // "prod_123"
            .searchableContent(extractContent(entity))
            .embeddings(generateEmbeddings(entity))
            .metadata(extractMetadata(entity))
            .createdAt(LocalDateTime.now())
            .build();
        
        // Save to database (ai_searchable_entities + ai_embeddings tables)
        searchableEntityRepository.save(aiEntity);
    }
}
```

---

## üéØ **Summary**

### **Where AISearchableEntity is Stored:**

#### **‚úÖ Development Environment**
- **Database**: H2 In-Memory Database (`jdbc:h2:mem:devdb`)
- **Physical Location**: RAM only (no persistent files)
- **Tables**: `ai_searchable_entities` + `ai_embeddings`
- **Access**: H2 Console at `http://localhost:8081/h2-console`
- **Persistence**: Lost on application restart

#### **‚úÖ Production Environment**  
- **Database**: PostgreSQL (specified in `DATABASE_URL`)
- **Physical Location**: Production database server
- **Tables**: `ai_searchable_entities` + `ai_embeddings`
- **Access**: Direct PostgreSQL connection
- **Persistence**: Permanent with database backups

#### **‚úÖ Table Structure**
- **Main Table**: `ai_searchable_entities` (metadata, content, analysis)
- **Embeddings Table**: `ai_embeddings` (vector dimensions, 1536 rows per entity)
- **Relationship**: One-to-many (one entity ‚Üí 1536 embedding values)

#### **‚úÖ Schema Management**
- **Development**: Hibernate auto-creates tables (`ddl-auto: create-drop`)
- **Production**: Hibernate validates + Liquibase migrations (`ddl-auto: validate`)
- **Note**: AI tables not yet included in Liquibase migrations

#### **‚úÖ Key Points**
- **JPA Entity**: `@Table(name = "ai_searchable_entities")`
- **Repository**: `AISearchableEntityRepository` for data access
- **Auto-Generated**: Tables created by Hibernate based on entity annotations
- **Environment-Specific**: H2 for dev, PostgreSQL for production
- **Vector Storage**: Each 1536-dimension embedding stored as 1536 database rows

The `AISearchableEntity` is stored in **standard relational database tables** that are automatically created by Hibernate based on the JPA annotations! üóÑÔ∏è